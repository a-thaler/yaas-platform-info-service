load_module modules/ngx_http_lua_module.so;
load_module modules/ngx_http_echo_module.so;
load_module modules/ngx_http_headers_more_filter_module.so;
load_module modules/ngx_http_geoip_module.so;

worker_processes  1;

error_log stderr debug; #notice;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    access_log /dev/stdout;

    keepalive_timeout  65;
    sendfile           on;
    gzip               on;

	geoip_country  /etc/nginx/geoip/GeoIP-Country.dat;
	geoip_city     /etc/nginx/geoip/GeoIP-City.dat;

    include        /var/nginx/config/timezone.conf;

    map $uri $basename {
        ~/(?<captured_basename>[^/]*)$ $captured_basename;
    }

    # set search paths for pure Lua external libraries (';;' is the default path):
    lua_package_path '/usr/lib/lua/5.1/?.lua;/usr/lib/lua/5.1/?/init.lua;;';

    # set search paths for Lua external libraries written in C (can also use ';;'):
    lua_package_cpath '/usr/lib/lua/5.1/?.so;;';

    lua_shared_dict cache 5m;

    init_by_lua_file /var/nginx/lua/init.lua;

    server {
        set         $folder '/var/nginx';

        listen      80;
        server_name localhost;
        root        $folder;

	    set_real_ip_from  10.0.0.0/8;
        set_real_ip_from  127.0.0.1;
	    real_ip_header    X-Forwarded-For;
        real_ip_recursive on;

        add_header Cache-Control no-cache;
        add_header Access-Control-Allow-Origin *;
        charset utf-8;
        default_type 'application/json';

        location =/header {
            charset off;
            default_type text/plain;

            echo $echo_client_request_headers;
        }

        location =/test {
            charset off;
            default_type text/plain;

            set $base_url "${scheme}://${server_name}:${server_port}";
            echo $scheme $server_name $server_port $uri $request $base_url;
        }

        location ~/info/?(?<ip>.*) {
            if ($ip = "") {
                set $ip $remote_addr;
            }
            if ($ip !~ '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$') {
                return 400;
            }

            proxy_set_header X-Forwarded-For $ip;
            proxy_set_header Host $host;
            proxy_set_header X-Request-For $request;
            proxy_pass $scheme://127.0.0.1/info;
        }

        location =/info {

            if ( $http_x_request_for ) {
                access_log off;
            }

            content_by_lua_file $folder/lua/info.lua;
        }

        location =/regions {
            add_header Cache-Control "public";
            expires 1h;
            content_by_lua_file $folder/lua/regions_collection.lua;
        }

        location /regions/ {
            add_header Cache-Control "public";
            expires 1h;
            content_by_lua_file $folder/lua/region_entity.lua;
        }

        location =/markets {
            add_header Cache-Control "public";
            expires 1h;
            content_by_lua_file $folder/lua/markets_collection.lua;
        }

        location /markets/ {
            add_header Cache-Control "public";
            expires 1h;
            content_by_lua_file $folder/lua/market_entity.lua;
        }

        location /data/ {
            internal;
            try_files $uri $uri.json;
        }

        location /meta_data/ {
            add_header Cache-Control "public";
            expires 1h;
            default_type 'application/yaml';
            try_files /meta/$basename /meta/$basename.yaml;
        }

        location /meta_data/schemata/ {
            add_header Cache-Control "public";
            expires 1h;
            default_type 'application/json';
            try_files /meta/schemata/$basename /meta/schemata/$basename.json;
        }


#        error_page 403 404 405 @40x;
#        location @40x {
#            try_files /etc/nginx/data/yaas.json =405;
#        }
#        error_page 500 502 503 504 =500 @50x;
#        location @50x {
#            try_files 50x.json =500;
#        }
    }
}